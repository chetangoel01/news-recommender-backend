<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Recommender API Demo</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .auth-section, .demo-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e8f4fd;
            border-radius: 12px;
            background: #f8fbff;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        /* Google Sign-In button styling */
        .g_id_signin {
            margin: 15px 0;
        }

        .google-auth-info {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .google-auth-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .response-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }

        .user-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .article-card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            background: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .article-card.bookmarked {
            border-left: 4px solid #f39c12;
            background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
        }

        .article-card.bookmarked::before {
            content: "üîñ";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2em;
        }

        .article-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #2c3e50;
            line-height: 1.4;
        }

        .article-summary {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #888;
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: #f8fbff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }
            
            .articles-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóûÔ∏è News Recommender API Demo</h1>
            <p>Test all endpoints of your news recommendation backend</p>
        </div>

        <div class="main-content">
            <!-- Authentication Section -->
            <div class="auth-section">
                <h2 class="section-title">üîê Authentication</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('login')">Login</div>
                    <div class="tab" onclick="switchTab('register')">Register</div>
                    <div class="tab" onclick="switchTab('google')">Google Auth</div>
                </div>

                <!-- Login Tab -->
                <div id="login-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="login-email">Email:</label>
                        <input type="email" id="login-email" placeholder="user@example.com" value="user@example.com">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password:</label>
                        <input type="password" id="login-password" placeholder="Password" value="password">
                    </div>
                    <button onclick="login()">Login</button>
                </div>

                <!-- Register Tab -->
                <div id="register-tab" class="tab-content">
                    <div class="form-group">
                        <label for="register-email">Email:</label>
                        <input type="email" id="register-email" placeholder="newuser@example.com">
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password:</label>
                        <input type="password" id="register-password" placeholder="At least 8 characters">
                    </div>
                    <div class="form-group">
                        <label for="register-username">Username:</label>
                        <input type="text" id="register-username" placeholder="username123">
                    </div>
                    <div class="form-group">
                        <label for="register-display-name">Display Name:</label>
                        <input type="text" id="register-display-name" placeholder="John Doe">
                    </div>
                    <button onclick="register()">Register</button>
                </div>

                <!-- Google Auth Tab -->
                <div id="google-tab" class="tab-content">
                    <div class="google-auth-info">
                        <h4>üîê Google Authentication</h4>
                        <p>Click the button below to sign in with Google. This will create a new user account if you haven't signed in before.</p>
                    </div>
                    <div class="form-group">
                        <div id="g_id_onload"
                             data-client_id="1037806407817-74m2hjth7i31u2410biova9dsl3ph74l.apps.googleusercontent.com"
                             data-callback="handleGoogleCredentialResponse"
                             data-auto_prompt="false"
                             data-ux_mode="popup">
                        </div>
                        <div class="g_id_signin" 
                             data-type="standard" 
                             data-size="large" 
                             data-theme="outline" 
                             data-text="sign_in_with" 
                             data-shape="rectangular" 
                             data-logo_alignment="left">
                        </div>
                    </div>
                    <div class="form-group">
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            <strong>Status:</strong> <span id="google-auth-status">Ready to authenticate</span>
                        </p>
                    </div>
                </div>

                <div id="auth-status"></div>
                <div id="user-info" class="user-info hidden"></div>
            </div>

            <!-- Demo Section -->
            <div class="demo-section">
                <h2 class="section-title">üöÄ API Demo</h2>
                <p style="margin-bottom: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #3498db;">
                    <strong>‚ú® Complete API Demo:</strong> Test all engagement features including likes, shares, bookmarks, and ML personalization! 
                    Features individual user tracking for all interactions (shares are the strongest engagement signal for ML recommendations).
                    <br><br>
                    <strong>üÜï Robust Pagination:</strong> Now using composite cursors (score + article ID) to eliminate duplicates between pages and ensure stable ordering!
                </p>

                <div class="button-group">
                    <button onclick="getArticles()" id="get-articles-btn" disabled>Get Articles</button>
                    <button onclick="getPersonalizedFeed()" id="get-feed-btn" disabled>üéØ Personalized Feed</button>
                    <button onclick="getTrendingFeed()" id="get-trending-btn" disabled>üî• Trending Feed</button>
                    <button onclick="getUserProfile()" id="get-profile-btn" disabled>Get Profile</button>
                    <button onclick="updateProfile()" id="update-profile-btn" disabled>Update Profile</button>
                    <button onclick="getUserBookmarks()" id="get-bookmarks-btn" disabled>My Bookmarks</button>
                    <button onclick="getEmbeddingStatus()" id="get-embedding-btn" disabled>Embedding Status</button>
                    <button onclick="testEmbeddingUpdate()" id="test-embedding-btn" disabled>Test Embedding Update</button>
                    <button onclick="logout()" id="logout-btn" disabled>Logout</button>
                </div>

                <!-- Feed Filters -->
                <div id="feed-filters" class="hidden">
                    <h3>Feed Filters:</h3>
                    <div style="display: flex; gap: 15px; margin: 15px 0; flex-wrap: wrap;">
                        <div>
                            <label for="feed-limit">Limit:</label>
                            <select id="feed-limit">
                                <option value="20">20</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div>
                            <label for="feed-diversify">Diversify:</label>
                            <select id="feed-diversify">
                                <option value="true" selected>Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div>
                            <label for="feed-content-type">Content Type:</label>
                            <select id="feed-content-type">
                                <option value="mixed" selected>Mixed</option>
                                <option value="articles">Articles</option>
                                <option value="videos">Videos</option>
                            </select>
                        </div>
                        <div>
                            <label for="feed-cursor">Cursor (for pagination):</label>
                            <input type="text" id="feed-cursor" placeholder="Leave empty for first page">
                        </div>
                    </div>
                </div>

                <!-- Trending Feed Filters -->
                <div id="trending-filters" class="hidden">
                    <h3>Trending Filters:</h3>
                    <div style="display: flex; gap: 15px; margin: 15px 0; flex-wrap: wrap;">
                        <div>
                            <label for="trending-timeframe">Timeframe:</label>
                            <select id="trending-timeframe">
                                <option value="1h">1 Hour</option>
                                <option value="6h">6 Hours</option>
                                <option value="24h" selected>24 Hours</option>
                                <option value="7d">7 Days</option>
                            </select>
                        </div>
                        <div>
                            <label for="trending-category">Category:</label>
                            <select id="trending-category">
                                <option value="">All Categories</option>
                                <option value="technology">Technology</option>
                                <option value="business">Business</option>
                                <option value="sports">Sports</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="health">Health</option>
                            </select>
                        </div>
                        <div>
                            <label for="trending-limit">Limit:</label>
                            <select id="trending-limit">
                                <option value="20">20</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div>
                            <label for="trending-cursor">Cursor (trending score):</label>
                            <input type="text" id="trending-cursor" placeholder="Leave empty for first page">
                        </div>
                    </div>
                </div>

                <!-- Articles Filter -->
                <div id="articles-filters" class="hidden">
                    <h3>Article Filters:</h3>
                    <div style="display: flex; gap: 15px; margin: 15px 0; flex-wrap: wrap;">
                        <div>
                            <label for="category-filter">Category:</label>
                            <select id="category-filter">
                                <option value="">All Categories</option>
                                <option value="technology">Technology</option>
                                <option value="business">Business</option>
                                <option value="sports">Sports</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="health">Health</option>
                            </select>
                        </div>
                        <div>
                            <label for="sort-filter">Sort:</label>
                            <select id="sort-filter">
                                <option value="recent">Recent</option>
                                <option value="trending">Trending</option>
                                <option value="relevance">Relevance</option>
                            </select>
                        </div>
                        <div>
                            <label for="limit-filter">Limit:</label>
                            <select id="limit-filter">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="response-container"></div>
                <div id="articles-container"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentToken = null;
        let currentUser = null;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Utility functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showResponse(data, title = 'API Response') {
            const container = document.getElementById('response-container');
            container.innerHTML = `
                <h3>${title}:</h3>
                <div class="response-box">${JSON.stringify(data, null, 2)}</div>
            `;
        }

        function updateUserInfo(userData) {
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `
                <h3>üë§ Logged in as:</h3>
                <p><strong>Username:</strong> ${userData.username}</p>
                <p><strong>Display Name:</strong> ${userData.display_name || 'Not set'}</p>
                <p><strong>Email:</strong> ${userData.email || 'Not set'}</p>
                <p><strong>User ID:</strong> ${userData.user_id}</p>
            `;
            userInfoDiv.classList.remove('hidden');
        }

        function enableDemoButtons() {
            const buttons = ['get-articles-btn', 'get-feed-btn', 'get-trending-btn', 'get-profile-btn', 'update-profile-btn', 
                           'get-bookmarks-btn', 'get-embedding-btn', 'test-embedding-btn', 'logout-btn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = false;
            });
            document.getElementById('articles-filters').classList.remove('hidden');
            document.getElementById('feed-filters').classList.remove('hidden');
            document.getElementById('trending-filters').classList.remove('hidden');
        }

        function disableDemoButtons() {
            const buttons = ['get-articles-btn', 'get-feed-btn', 'get-trending-btn', 'get-profile-btn', 'update-profile-btn', 
                           'get-bookmarks-btn', 'get-embedding-btn', 'test-embedding-btn', 'logout-btn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = true;
            });
            document.getElementById('articles-filters').classList.add('hidden');
            document.getElementById('feed-filters').classList.add('hidden');
            document.getElementById('trending-filters').classList.add('hidden');
        }

        // API calls
        async function makeRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (currentToken) {
                defaultOptions.headers['Authorization'] = `Bearer ${currentToken}`;
            }

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers,
                },
            };

            try {
                const response = await fetch(url, finalOptions);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || `HTTP error! status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // Authentication functions
        async function register() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('register-username').value;
            const displayName = document.getElementById('register-display-name').value;

            if (!email || !password || !username || !displayName) {
                showStatus('Please fill all fields', 'error');
                return;
            }

            try {
                showStatus('Registering...', 'info');
                const data = await makeRequest('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({
                        email,
                        password,
                        username,
                        display_name: displayName
                    }),
                });

                currentToken = data.access_token;
                currentUser = data;
                
                showStatus('Registration successful!', 'success');
                showResponse(data, 'Registration Response');
                updateUserInfo(data);
                enableDemoButtons();
                
            } catch (error) {
                showStatus(`Registration failed: ${error.message}`, 'error');
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showStatus('Please fill all fields', 'error');
                return;
            }

            try {
                showStatus('Logging in...', 'info');
                const data = await makeRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email,
                        password
                    }),
                });

                currentToken = data.access_token;
                currentUser = data;
                
                showStatus('Login successful!', 'success');
                showResponse(data, 'Login Response');
                updateUserInfo(data);
                enableDemoButtons();
                
            } catch (error) {
                showStatus(`Login failed: ${error.message}`, 'error');
            }
        }

        // Google Authentication
        function handleGoogleCredentialResponse(response) {
            console.log('Google Sign-In response received:', response);
            
            if (response.credential) {
                authenticateWithGoogle(response.credential);
            } else {
                showStatus('Google Sign-In failed: No credential received', 'error');
            }
        }

        async function authenticateWithGoogle(idToken) {
            try {
                showStatus('Authenticating with Google...', 'info');
                document.getElementById('google-auth-status').textContent = 'Authenticating...';
                
                const data = await makeRequest('/auth/google', {
                    method: 'POST',
                    body: JSON.stringify({
                        id_token: idToken
                    }),
                });

                currentToken = data.access_token;
                currentUser = data;
                
                showStatus('Google authentication successful!', 'success');
                document.getElementById('google-auth-status').textContent = 'Authentication successful!';
                showResponse(data, 'Google Auth Response');
                updateUserInfo(data);
                enableDemoButtons();
                
                // Switch back to login tab to show user info
                switchTab('login');
                
            } catch (error) {
                showStatus(`Google authentication failed: ${error.message}`, 'error');
                document.getElementById('google-auth-status').textContent = 'Authentication failed';
                console.error('Google auth error:', error);
            }
        }

        function logout() {
            currentToken = null;
            currentUser = null;
            
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('auth-status').style.display = 'none';
            document.getElementById('response-container').innerHTML = '';
            document.getElementById('articles-container').innerHTML = '';
            
            disableDemoButtons();
            showStatus('Logged out successfully', 'success');
        }

        // Demo functions
        async function getArticles() {
            try {
                showStatus('Fetching articles...', 'info');
                
                const category = document.getElementById('category-filter').value;
                const sort = document.getElementById('sort-filter').value;
                const limit = document.getElementById('limit-filter').value;
                
                let queryParams = new URLSearchParams({
                    sort,
                    limit,
                    page: '1'
                });
                
                if (category) {
                    queryParams.append('category', category);
                }
                
                const data = await makeRequest(`/articles?${queryParams}`);
                
                showStatus('Articles fetched successfully!', 'success');
                showResponse(data, 'Articles Response');
                displayArticles(data.articles);
                
            } catch (error) {
                showStatus(`Failed to fetch articles: ${error.message}`, 'error');
            }
        }

        async function getPersonalizedFeed() {
            try {
                showStatus('Fetching personalized feed...', 'info');
                
                const limit = document.getElementById('feed-limit').value;
                const diversify = document.getElementById('feed-diversify').value;
                const contentType = document.getElementById('feed-content-type').value;
                const cursor = document.getElementById('feed-cursor').value;
                
                let queryParams = new URLSearchParams({
                    limit,
                    diversify,
                    content_type: contentType,
                    refresh: 'false'
                });
                
                if (cursor) {
                    queryParams.append('cursor', cursor);
                }
                
                const data = await makeRequest(`/feed/personalized?${queryParams}`);
                
                showStatus('Personalized feed fetched successfully!', 'success');
                showResponse(data, 'Personalized Feed Response');
                displayFeedArticles(data.articles, 'Personalized Feed', data.next_cursor, data.has_more);
                
                // Show feed metadata
                const container = document.getElementById('articles-container');
                const metadataInfo = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745;">
                        <h4>üéØ Feed Metadata:</h4>
                        <p><strong>Personalization Strength:</strong> ${(data.feed_metadata.personalization_strength * 100).toFixed(1)}%</p>
                        <p><strong>Diversity Score:</strong> ${(data.feed_metadata.diversity_score * 100).toFixed(1)}%</p>
                        <p><strong>Algorithm Version:</strong> ${data.feed_metadata.algorithm_version}</p>
                        <p><strong>Generated At:</strong> ${new Date(data.feed_metadata.generated_at).toLocaleString()}</p>
                        <p><strong>Cache TTL:</strong> ${data.feed_metadata.cache_ttl_minutes} minutes</p>
                        <p><strong>Preload Next Batch:</strong> ${data.preload_next_batch ? 'Yes' : 'No'}</p>
                        ${data.next_cursor ? `<p><strong>Next Cursor:</strong> <code>${data.next_cursor}</code></p>` : ''}
                        <p><strong>Has More:</strong> ${data.has_more ? 'Yes' : 'No'}</p>
                    </div>
                `;
                
                if (container.innerHTML.includes('üì∞ Articles')) {
                    container.innerHTML = container.innerHTML.replace('</div>', metadataInfo + '</div>');
                } else {
                    container.innerHTML = metadataInfo + container.innerHTML;
                }
                
            } catch (error) {
                showStatus(`Failed to fetch personalized feed: ${error.message}`, 'error');
            }
        }

        async function getTrendingFeed() {
            try {
                showStatus('Fetching trending feed...', 'info');
                
                const timeframe = document.getElementById('trending-timeframe').value;
                const category = document.getElementById('trending-category').value;
                const limit = document.getElementById('trending-limit').value;
                const cursor = document.getElementById('trending-cursor').value;
                
                let queryParams = new URLSearchParams({
                    timeframe,
                    limit
                });
                
                if (category) {
                    queryParams.append('category', category);
                }
                if (cursor) {
                    queryParams.append('cursor', cursor);
                }
                
                const data = await makeRequest(`/feed/trending?${queryParams}`);
                
                showStatus('Trending feed fetched successfully!', 'success');
                showResponse(data, 'Trending Feed Response');
                displayTrendingArticles(data.articles, data.trending_topics, data.next_cursor, data.has_more);
                
            } catch (error) {
                showStatus(`Failed to fetch trending feed: ${error.message}`, 'error');
            }
        }

        function displayArticles(articles) {
            const container = document.getElementById('articles-container');
            
            if (!articles || articles.length === 0) {
                container.innerHTML = '<p>No articles found.</p>';
                return;
            }
            
            container.innerHTML = `
                <h3>üì∞ Articles (${articles.length} found):</h3>
                <div class="articles-grid">
                    ${articles.map(article => `
                        <div class="article-card ${article.engagement?.user_bookmarked ? 'bookmarked' : ''}" onclick="getArticleDetails('${article.id}')">
                            <div class="article-title">${article.title}</div>
                            <div class="article-summary">${article.summary || 'No summary available'}</div>
                            <div class="article-meta">
                                <span>üì∞ ${article.source?.name || 'Unknown'}</span>
                                <span>üëÄ ${article.engagement?.views || 0} views</span>
                                <span>‚ù§Ô∏è ${article.engagement?.likes || 0} likes</span>
                                <span>üì§ ${article.engagement?.shares || 0} shares</span>
                                <span>üîñ ${article.engagement?.user_bookmarked ? 'Bookmarked' : 'Not bookmarked'}</span>
                            </div>
                            <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="event.stopPropagation(); toggleLike('${article.id}', ${article.engagement?.user_liked || false})" class="${article.engagement?.user_liked ? 'success' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_liked ? '‚ù§Ô∏è Liked' : 'ü§ç Like'}
                                </button>
                                <button onclick="event.stopPropagation(); shareArticle('${article.id}')" class="${article.engagement?.user_shared ? 'warning' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_shared ? 'üì§ Shared' : 'üì§ Share'}
                                </button>
                                <button onclick="event.stopPropagation(); toggleBookmark('${article.id}', ${article.engagement?.user_bookmarked || false})" class="${article.engagement?.user_bookmarked ? 'success' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_bookmarked ? 'üîñ Bookmarked' : 'üìë Bookmark'}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayFeedArticles(articles, feedType, nextCursor, hasMore) {
            const container = document.getElementById('articles-container');
            
            if (!articles || articles.length === 0) {
                container.innerHTML = '<p>No articles found in feed.</p>';
                return;
            }
            
            container.innerHTML = `
                <h3>üéØ ${feedType} (${articles.length} articles):</h3>
                <div class="articles-grid">
                    ${articles.map(article => `
                        <div class="article-card ${article.engagement?.user_bookmarked ? 'bookmarked' : ''}" onclick="getArticleDetails('${article.id}')">
                            <div class="article-title">${article.title}</div>
                            <div class="article-summary">${article.summary || 'No summary available'}</div>
                            
                            <!-- Feed-specific metadata -->
                            <div style="background: #f0f8ff; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #3498db;">
                                <div style="font-size: 0.9em; color: #2c3e50;">
                                    <div><strong>üéØ Recommendation:</strong> ${article.recommendation_reason || 'Recommended for you'}</div>
                                    <div><strong>üìä Confidence:</strong> ${(article.confidence_score * 100).toFixed(1)}%</div>
                                    <div><strong>‚è±Ô∏è Read Time:</strong> ${article.estimated_read_time || 'Unknown'}</div>
                                    ${article.engagement_prediction ? `
                                        <div style="margin-top: 8px;">
                                            <strong>üîÆ Engagement Prediction:</strong>
                                            <div style="font-size: 0.8em; color: #666;">
                                                ‚ù§Ô∏è Like: ${(article.engagement_prediction.likely_to_like * 100).toFixed(1)}% | 
                                                üì§ Share: ${(article.engagement_prediction.likely_to_share * 100).toFixed(1)}% | 
                                                üìñ Read: ${(article.engagement_prediction.likely_to_read_full * 100).toFixed(1)}%
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="article-meta">
                                <span>üì∞ ${article.source?.name || 'Unknown'}</span>
                                <span>üëÄ ${article.engagement?.views || 0} views</span>
                                <span>‚ù§Ô∏è ${article.engagement?.likes || 0} likes</span>
                                <span>üì§ ${article.engagement?.shares || 0} shares</span>
                                <span>üîñ ${article.engagement?.user_bookmarked ? 'Bookmarked' : 'Not bookmarked'}</span>
                            </div>
                            <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="event.stopPropagation(); toggleLike('${article.id}', ${article.engagement?.user_liked || false})" class="${article.engagement?.user_liked ? 'success' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_liked ? '‚ù§Ô∏è Liked' : 'ü§ç Like'}
                                </button>
                                <button onclick="event.stopPropagation(); shareArticle('${article.id}')" class="${article.engagement?.user_shared ? 'warning' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_shared ? 'üì§ Shared' : 'üì§ Share'}
                                </button>
                                <button onclick="event.stopPropagation(); toggleBookmark('${article.id}', ${article.engagement?.user_bookmarked || false})" class="${article.engagement?.user_bookmarked ? 'success' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_bookmarked ? 'üîñ Bookmarked' : 'üìë Bookmark'}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${hasMore ? `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="getPersonalizedFeed()" class="button-group">Load More</button>
                    </div>
                ` : ''}
            `;
        }

        function displayTrendingArticles(articles, trendingTopics, nextCursor, hasMore) {
            const container = document.getElementById('articles-container');
            
            if (!articles || articles.length === 0) {
                container.innerHTML = '<p>No trending articles found.</p>';
                return;
            }
            
            // Show trending topics first
            let trendingTopicsHtml = '';
            if (trendingTopics && trendingTopics.length > 0) {
                trendingTopicsHtml = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <h4>üî• Trending Topics:</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            ${trendingTopics.map(topic => `
                                <span style="background: #ffeaa7; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                    ${topic.topic} (${topic.mention_count} mentions)
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <h3>üî• Trending Feed (${articles.length} articles):</h3>
                ${trendingTopicsHtml}
                <div class="articles-grid">
                    ${articles.map(article => `
                        <div class="article-card ${article.engagement?.user_bookmarked ? 'bookmarked' : ''}" onclick="getArticleDetails('${article.id}')">
                            <div class="article-title">${article.title}</div>
                            <div class="article-summary">${article.summary || 'No summary available'}</div>
                            
                            <!-- Trending-specific metadata -->
                            <div style="background: #fff5f5; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #e74c3c;">
                                <div style="font-size: 0.9em; color: #2c3e50;">
                                    <div><strong>üî• Trend Score:</strong> ${article.trend_score ? article.trend_score.toFixed(2) : 'N/A'}</div>
                                    <div><strong>üìà Rank:</strong> #${article.trending_rank || 'N/A'}</div>
                                    <div><strong>‚ö° Velocity:</strong> ${article.velocity || 'N/A'}</div>
                                    ${article.engagement_metrics ? `
                                        <div style="margin-top: 8px;">
                                            <strong>üìä Engagement:</strong>
                                            <div style="font-size: 0.8em; color: #666;">
                                                üëÄ Views/hr: ${article.engagement_metrics.views_last_hour || 0} | 
                                                üì§ Shares/min: ${article.engagement_metrics.shares_per_minute ? article.engagement_metrics.shares_per_minute.toFixed(1) : 0}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="article-meta">
                                <span>üì∞ ${article.source?.name || 'Unknown'}</span>
                                <span>üëÄ ${article.engagement?.views || 0} views</span>
                                <span>‚ù§Ô∏è ${article.engagement?.likes || 0} likes</span>
                                <span>üì§ ${article.engagement?.shares || 0} shares</span>
                                <span>üîñ ${article.engagement?.user_bookmarked ? 'Bookmarked' : 'Not bookmarked'}</span>
                            </div>
                            <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="event.stopPropagation(); toggleLike('${article.id}', ${article.engagement?.user_liked || false})" class="${article.engagement?.user_liked ? 'success' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_liked ? '‚ù§Ô∏è Liked' : 'ü§ç Like'}
                                </button>
                                <button onclick="event.stopPropagation(); shareArticle('${article.id}')" class="${article.engagement?.user_shared ? 'warning' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_shared ? 'üì§ Shared' : 'üì§ Share'}
                                </button>
                                <button onclick="event.stopPropagation(); toggleBookmark('${article.id}', ${article.engagement?.user_bookmarked || false})" class="${article.engagement?.user_bookmarked ? 'success' : ''}" style="min-width: auto; padding: 8px 16px;">
                                    ${article.engagement?.user_bookmarked ? 'üîñ Bookmarked' : 'üìë Bookmark'}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${hasMore ? `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="getTrendingFeed()" class="button-group">Load More</button>
                    </div>
                ` : ''}
            `;
        }

        async function getArticleDetails(articleId) {
            try {
                showStatus('Fetching article details...', 'info');
                const data = await makeRequest(`/articles/${articleId}`);
                
                showStatus('Article details fetched!', 'success');
                showResponse(data, `Article Details: ${data.title}`);
                
                // Track the view
                trackArticleView(articleId);
                
            } catch (error) {
                showStatus(`Failed to fetch article details: ${error.message}`, 'error');
            }
        }

        async function toggleLike(articleId, isCurrentlyLiked) {
            try {
                const method = isCurrentlyLiked ? 'DELETE' : 'POST';
                const action = isCurrentlyLiked ? 'unlike' : 'like';
                
                showStatus(`${isCurrentlyLiked ? 'Unliking' : 'Liking'} article...`, 'info');
                
                const data = await makeRequest(`/articles/${articleId}/like`, {
                    method: method
                });
                
                showStatus(`Article ${action}d successfully!`, 'success');
                showResponse(data, `${action.charAt(0).toUpperCase() + action.slice(1)} Response`);
                
                // Refresh articles to show updated status
                setTimeout(() => {
                    getArticles();
                }, 1000);
                
            } catch (error) {
                showStatus(`Failed to ${isCurrentlyLiked ? 'unlike' : 'like'} article: ${error.message}`, 'error');
            }
        }

        async function toggleBookmark(articleId, isCurrentlyBookmarked) {
            try {
                const method = isCurrentlyBookmarked ? 'DELETE' : 'POST';
                const action = isCurrentlyBookmarked ? 'remove bookmark from' : 'bookmark';
                
                showStatus(`${isCurrentlyBookmarked ? 'Removing bookmark from' : 'Bookmarking'} article...`, 'info');
                
                const data = await makeRequest(`/articles/${articleId}/bookmark`, {
                    method: method
                });
                
                showStatus(`Article ${action}ed successfully!`, 'success');
                showResponse(data, `Bookmark Response`);
                
                // Refresh articles to show updated status
                setTimeout(() => {
                    getArticles();
                }, 1000);
                
            } catch (error) {
                showStatus(`Failed to ${action} article: ${error.message}`, 'error');
            }
        }

        // Legacy function for backward compatibility
        async function likeArticle(articleId) {
            return toggleLike(articleId, false);
        }

        async function shareArticle(articleId) {
            try {
                showStatus('Sharing article...', 'info');
                
                const data = await makeRequest(`/articles/${articleId}/share`, {
                    method: 'POST',
                    body: JSON.stringify({
                        platform: 'demo',
                        message: 'Check out this article from the News Recommender demo!'
                    })
                });
                
                showStatus('Article shared successfully!', 'success');
                showResponse(data, 'Share Response');
                
                // Show share success info with enhanced features
                const container = document.getElementById('articles-container');
                const shareInfo = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <h4>üì§ Enhanced Article Sharing!</h4>
                        <p><strong>Share ID:</strong> ${data.share_id}</p>
                        <p><strong>Share URL:</strong> <a href="${data.share_url}" target="_blank">${data.share_url}</a></p>
                        <p><strong>Total Shares:</strong> ${data.total_shares} (across all users)</p>
                        <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px;">
                            <strong>üÜï New Features:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li><strong>Enhanced Messages:</strong> Article title automatically included in share message!</li>
                                <li><strong>Share Counting:</strong> Multiple shares from same user now increment count</li>
                                <li><strong>Individual Tracking:</strong> Each user's share count tracked separately</li>
                            </ul>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px;">
                            <strong>üß† ML Insight:</strong> Shares are the strongest engagement signal! Multiple shares from the same user 
                            indicate very high interest and dramatically boost recommendation weights. Try sharing the same article again 
                            to see the count increment!
                        </div>
                    </div>
                `;
                
                // Append to existing content or create new
                if (container.innerHTML.includes('üì∞ Articles')) {
                    container.innerHTML = container.innerHTML.replace('</div>', shareInfo + '</div>');
                } else {
                    container.innerHTML = shareInfo + container.innerHTML;
                }
                
                // Refresh articles to show updated share status
                setTimeout(() => {
                    getArticles();
                }, 2000);
                
            } catch (error) {
                showStatus(`Failed to share article: ${error.message}`, 'error');
            }
        }

        async function trackArticleView(articleId) {
            try {
                const data = await makeRequest(`/articles/${articleId}/view`, {
                    method: 'POST',
                    body: JSON.stringify({
                        view_duration_seconds: 45,
                        percentage_read: 75,
                        interaction_type: 'click'
                    })
                });
                
                console.log('View tracked:', data);
                
            } catch (error) {
                console.error('Failed to track view:', error);
            }
        }

        async function getUserProfile() {
            try {
                showStatus('Fetching user profile...', 'info');
                const data = await makeRequest('/users/profile');
                
                showStatus('Profile fetched successfully!', 'success');
                showResponse(data, 'User Profile');
                
            } catch (error) {
                showStatus(`Failed to fetch profile: ${error.message}`, 'error');
            }
        }

        async function updateProfile() {
            const newDisplayName = prompt('Enter new display name:');
            const newBio = prompt('Enter bio:');
            
            if (!newDisplayName && !newBio) {
                showStatus('No changes made', 'info');
                return;
            }
            
            try {
                showStatus('Updating profile...', 'info');
                const updateData = {};
                if (newDisplayName) updateData.display_name = newDisplayName;
                if (newBio) updateData.bio = newBio;
                
                const data = await makeRequest('/users/profile', {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });
                
                showStatus('Profile updated successfully!', 'success');
                showResponse(data, 'Updated Profile');
                
            } catch (error) {
                showStatus(`Failed to update profile: ${error.message}`, 'error');
            }
        }

        async function getUserBookmarks() {
            try {
                showStatus('Fetching bookmarks...', 'info');
                const data = await makeRequest('/users/bookmarks');
                
                showStatus('Bookmarks fetched successfully!', 'success');
                showResponse(data, 'User Bookmarks API Response');
                
                // Display bookmarks in a nice format
                displayBookmarks(data.bookmarks || []);
                
            } catch (error) {
                showStatus(`Failed to fetch bookmarks: ${error.message}`, 'error');
            }
        }

        function displayBookmarks(bookmarks) {
            const container = document.getElementById('articles-container');
            
            if (!bookmarks || bookmarks.length === 0) {
                container.innerHTML = '<h3>üìë My Bookmarks</h3><p>You haven\'t bookmarked any articles yet. Bookmark some articles and they\'ll appear here!</p>';
                return;
            }
            
            container.innerHTML = `
                <h3>üìë My Bookmarks (${bookmarks.length} articles):</h3>
                <div class="articles-grid">
                    ${bookmarks.map(bookmark => {
                        const article = bookmark.article;
                        return `
                            <div class="article-card bookmarked" onclick="getArticleDetails('${article.id}')">
                                <div class="article-title">${article.title}</div>
                                <div class="article-summary">${article.summary || 'No summary available'}</div>
                                <div class="article-meta">
                                    <span>üì∞ ${article.source?.name || 'Unknown'}</span>
                                    <span>üëÄ ${article.engagement?.views || 0} views</span>
                                    <span>‚ù§Ô∏è ${article.engagement?.likes || 0} likes</span>
                                    <span>üîñ Bookmarked on ${new Date(bookmark.bookmarked_at).toLocaleDateString()}</span>
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button onclick="event.stopPropagation(); toggleLike('${article.id}', ${article.engagement?.user_liked || false})" class="${article.engagement?.user_liked ? 'success' : ''}" style="min-width: auto; padding: 8px 16px;">
                                        ${article.engagement?.user_liked ? '‚ù§Ô∏è Liked' : 'ü§ç Like'}
                                    </button>
                                    <button onclick="event.stopPropagation(); shareArticle('${article.id}')" class="${article.engagement?.user_shared ? 'warning' : ''}" style="min-width: auto; padding: 8px 16px;">
                                        ${article.engagement?.user_shared ? 'üì§ Shared' : 'üì§ Share'}
                                    </button>
                                    <button onclick="event.stopPropagation(); toggleBookmark('${article.id}', true)" class="danger" style="min-width: auto; padding: 8px 16px;">
                                        üóëÔ∏è Remove Bookmark
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function getEmbeddingStatus() {
            try {
                showStatus('Fetching embedding status...', 'info');
                const data = await makeRequest('/users/embedding/status');
                
                showStatus('Embedding status fetched!', 'success');
                showResponse(data, 'Embedding Status');
                
            } catch (error) {
                showStatus(`Failed to fetch embedding status: ${error.message}`, 'error');
            }
        }

        async function testEmbeddingUpdate() {
            try {
                showStatus('Generating test embedding update...', 'info');
                
                // Generate a random 384-dimensional embedding vector
                const embeddingVector = Array.from({length: 384}, () => Math.random() * 2 - 1);
                
                // Create test interaction summary
                const testPayload = {
                    embedding_vector: embeddingVector,
                    interaction_summary: {
                        avg_read_time_seconds: 120.5 + Math.random() * 60,
                        engagement_metrics: {
                            liked_articles: Math.floor(Math.random() * 10),
                            shared_articles: Math.floor(Math.random() * 5),
                            bookmarked_articles: Math.floor(Math.random() * 8),
                            skipped_articles: Math.floor(Math.random() * 3)
                        },
                        category_exposure: {
                            technology: Math.floor(Math.random() * 15),
                            business: Math.floor(Math.random() * 10),
                            health: Math.floor(Math.random() * 8),
                            sports: Math.floor(Math.random() * 5),
                            entertainment: Math.floor(Math.random() * 12)
                        }
                    },
                    session_start: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                    session_end: new Date().toISOString(),
                    articles_processed: Math.floor(Math.random() * 20) + 5,
                    device_type: 'web_demo',
                    app_version: '1.0.0'
                };
                
                showStatus('Sending embedding update...', 'info');
                
                const data = await makeRequest('/users/embedding/update', {
                    method: 'POST',
                    body: JSON.stringify(testPayload)
                });
                
                showStatus('Embedding updated successfully!', 'success');
                showResponse(data, 'Embedding Update Response');
                
                // Show a summary of what was updated
                const container = document.getElementById('articles-container');
                container.innerHTML = `
                    <h3>üß† Embedding Update Test Results</h3>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 15px 0;">
                        <h4>‚úÖ Update Successful!</h4>
                        <p><strong>Personalization Score:</strong> ${(data.personalization_score * 100).toFixed(1)}%</p>
                        <p><strong>Diversity Adjustment:</strong> ${data.diversity_adjustment}</p>
                        <p><strong>Recommendations Refreshed:</strong> ${data.recommendations_refreshed ? 'Yes' : 'No'}</p>
                        <p><strong>Articles Processed:</strong> ${testPayload.articles_processed}</p>
                        <p><strong>Session Duration:</strong> ${Math.round((new Date(testPayload.session_end) - new Date(testPayload.session_start)) / 60000)} minutes</p>
                        
                        <h5>Engagement Metrics:</h5>
                        <ul>
                            <li>‚ù§Ô∏è Liked: ${testPayload.interaction_summary.engagement_metrics.liked_articles}</li>
                            <li>üì§ Shared: ${testPayload.interaction_summary.engagement_metrics.shared_articles}</li>
                            <li>üîñ Bookmarked: ${testPayload.interaction_summary.engagement_metrics.bookmarked_articles}</li>
                            <li>‚è≠Ô∏è Skipped: ${testPayload.interaction_summary.engagement_metrics.skipped_articles}</li>
                        </ul>
                        
                        <h5>Category Exposure:</h5>
                        <ul>
                            ${Object.entries(testPayload.interaction_summary.category_exposure)
                                .map(([category, count]) => `<li>${category}: ${count} articles</li>`)
                                .join('')}
                        </ul>
                        
                        <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                            üí° <strong>Tip:</strong> In a real app, this embedding would be computed on the user's device 
                            based on their actual reading behavior and sent to the server every ~10 articles for 
                            improved personalized recommendations.
                        </p>
                    </div>
                `;
                
            } catch (error) {
                showStatus(`Failed to update embedding: ${error.message}`, 'error');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('Ready! Please login or register to test the API.', 'info');
        });
    </script>
</body>
</html> 